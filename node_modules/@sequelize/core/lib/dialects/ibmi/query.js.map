{
  "version": 3,
  "sources": ["../../../src/dialects/ibmi/query.js"],
  "sourcesContent": ["'use strict';\n\nconst _ = require('lodash');\nconst AbstractQuery = require('../abstract/query');\nconst parserStore = require('../parserStore')('ibmi');\nconst SqlString = require('../../sql-string');\nconst sequelizeErrors = require('../../errors');\nconst { logger } = require('../../utils/logger');\n\nconst debug = logger.debugContext('sql:ibmi');\n\nclass Query extends AbstractQuery {\n  getInsertIdField() {\n    return 'id';\n  }\n\n  static formatBindParameters(sql, values, dialect) {\n    const bindParams = [];\n\n    const replacementFunc = (match, key, values_) => {\n\n      if (values_[key] !== undefined) {\n        bindParams.push(values_[key]);\n\n        return '?';\n      }\n    };\n\n    sql = AbstractQuery.formatBindParameters(sql, values, dialect, replacementFunc)[0];\n\n    return [sql, bindParams];\n  }\n\n  async run(sql, parameters) {\n    const stacktrace = new Error().stack;\n    this.sql = sql.replace(/;$/, '');\n\n    return new Promise((resolve, reject) => {\n      const complete = this._logQuery(sql, debug, parameters);\n      this.connection.query(this.sql, parameters, (error, results) => {\n\n        if (error) {\n          const formattedError = this.formatError(error, stacktrace);\n          reject(formattedError);\n\n          return;\n        }\n\n        complete();\n\n        // parse the results to the format sequelize expects\n        for (const result of results) {\n          for (const column of results.columns) {\n            const typeId = column.dataType;\n            const parse = parserStore.get(typeId);\n            const value = result[column.name];\n            if (value !== null && parse) {\n              result[column.name] = parse(value);\n            }\n          }\n        }\n\n        resolve(results);\n      });\n    })\n      .then(results => this.formatResults(results));\n  }\n\n  /**\n   * High level function that handles the results of a query execution.\n   *\n   *\n   * Example:\n   *  query.formatResults([\n   *    {\n   *      id: 1,              // this is from the main table\n   *      attr2: 'snafu',     // this is from the main table\n   *      Tasks.id: 1,        // this is from the associated table\n   *      Tasks.title: 'task' // this is from the associated table\n   *    }\n   *  ])\n   *\n   * @param {Array} data - The result of the query execution.\n   * @private\n   */\n  formatResults(data) {\n    let result = this.instance;\n\n    if (this.isInsertQuery() || this.isUpdateQuery() || this.isUpsertQuery()) {\n      if (this.instance && this.instance.dataValues) {\n        for (const key in data[0]) {\n          if (Object.prototype.hasOwnProperty.call(data[0], key)) {\n            const record = data[0][key];\n\n            const attr = _.find(this.model.rawAttributes, attribute => attribute.fieldName === key || attribute.field === key);\n\n            this.instance.dataValues[attr && attr.fieldName || key] = record;\n          }\n        }\n      }\n\n      if (this.isUpsertQuery()) {\n        return [\n          this.instance,\n          null,\n        ];\n      }\n\n      return [\n        this.instance || data && (this.options.plain && data[0] || data) || undefined,\n        data.count,\n      ];\n    }\n\n    if (this.isSelectQuery()) {\n      return this.handleSelectQuery(data);\n    }\n\n    if (this.isShowTablesQuery()) {\n      return this.handleShowTablesQuery(data);\n    }\n\n    if (this.isShowIndexesQuery()) {\n      return this.handleShowIndexesQuery(data);\n    }\n\n    if (this.isDescribeQuery()) {\n      result = {};\n\n      for (const _result of data) {\n        const enumRegex = /^enum/i;\n        result[_result.COLUMN_NAME] = {\n          type: enumRegex.test(_result.Type) ? _result.Type.replace(enumRegex, 'ENUM') : _result.DATA_TYPE.toUpperCase(),\n          allowNull: _result.IS_NULLABLE === 'Y',\n          defaultValue: _result.COLUMN_DEFAULT,\n          primaryKey: _result.CONSTRAINT_TYPE === 'PRIMARY KEY',\n          autoIncrement: _result.IS_GENERATED !== 'IDENTITY_GENERATION',\n        };\n      }\n\n      return result;\n    }\n\n    if (this.isCallQuery()) {\n      return data[0];\n    }\n\n    if (this.isBulkUpdateQuery() || this.isBulkDeleteQuery() || this.isUpsertQuery()) {\n      return data.count;\n    }\n\n    if (this.isVersionQuery()) {\n      return data[0].VERSION;\n    }\n\n    if (this.isForeignKeysQuery()) {\n      return data;\n    }\n\n    if (this.isInsertQuery(data)) {\n      // insert queries can't call count, because they are actually select queries wrapped around insert queries to get the inserted id. Need to count the number of results instead.\n      return [result, data.length];\n    }\n\n    if (this.isUpdateQuery()) {\n      return [result, data.count];\n    }\n\n    if (this.isShowConstraintsQuery()) {\n      return data;\n    }\n\n    if (this.isRawQuery()) {\n      // MySQL returns row data and metadata (affected rows etc) in a single object - let's standarize it, sorta\n      return [data, data];\n    }\n\n    if (this.isShowIndexesQuery()) {\n      return data;\n    }\n\n    return result;\n  }\n\n  handleInsertQuery(results, metaData) {\n    if (this.instance) {\n      // add the inserted row id to the instance\n      const autoIncrementAttribute = this.model.autoIncrementAttribute.field;\n      let id = null;\n\n      id = id || results && results[autoIncrementAttribute];\n      id = id || metaData && metaData[autoIncrementAttribute];\n\n      this.instance[this.model.autoIncrementAttribute] = id;\n    }\n  }\n\n  handleShowIndexesQuery(data) {\n\n    const indexes = Object.create(null);\n\n    data.forEach(item => {\n\n      if (Object.prototype.hasOwnProperty.call(indexes, item.NAME)) {\n        indexes[item.NAME].fields.push({ attribute: item.COLUMN_NAME, length: undefined, order: undefined, collate: undefined });\n      } else {\n        indexes[item.NAME] = {\n          primary: item.CONSTRAINT_TYPE === 'PRIMARY KEY',\n          fields: [{ attribute: item.COLUMN_NAME, length: undefined, order: undefined, collate: undefined }],\n          name: item.NAME,\n          tableName: item.TABLE_NAME,\n          unique: item.CONSTRAINT_TYPE === 'PRIMARY KEY' || item.CONSTRAINT_TYPE === 'UNIQUE',\n          type: item.CONSTRAINT_TYPE,\n        };\n      }\n    });\n\n    return Object.values(indexes);\n  }\n\n  formatError(err, stacktrace) {\n\n    // Db2 for i uses the `odbc` connector. The `odbc` connector returns a list\n    // of odbc errors, each of which has a code and a state. To determine the\n    // type of SequelizeError, check the code and create the associated error.\n    // Error codes can be found at:\n    // https://www.ibm.com/support/knowledgecenter/ssw_ibm_i_72/rzala/rzalaccl.htm\n\n    // some errors occur outside of ODBC (e.g. connection errors)\n    if (err.toString().includes('Error connecting to the database')) {\n      return new sequelizeErrors.ConnectionRefusedError(err);\n    }\n\n    if (Object.prototype.hasOwnProperty.call(err, 'odbcErrors') && err.odbcErrors.length > 0) {\n      const odbcError = err.odbcErrors[0];\n      const foreignKeyConstraintCodes = [\n        -530, // The insert or update value of a foreign key is invalid.\n        -531, // The update or delete of a parent key is prevented by a NO ACTION update or delete rule.\n        -532, // The update or delete of a parent key is prevented by a NO ACTION update or delete rule.\n      ];\n      const uniqueConstraintCodes = [\n        -803, // A violation of the constraint imposed by a unique index or a unique constraint occurred.\n      ];\n\n      if (foreignKeyConstraintCodes.includes(odbcError.code)) {\n        return new sequelizeErrors.ForeignKeyConstraintError({\n          parent: err,\n          sql: {},\n          fields: {},\n          stack: stacktrace,\n        });\n      }\n\n      if (uniqueConstraintCodes.includes(odbcError.code)) {\n        return new sequelizeErrors.UniqueConstraintError({\n          errors: err.odbcErrors,\n          parent: err,\n          sql: {},\n          fields: {},\n          stack: stacktrace,\n        });\n      }\n\n      if (odbcError.code === -204) {\n        let constraintName;\n        let type;\n        const constraintNameRegex = /\"([^)]+?)\" in [^]+? type (\\*\\w+?) not found./;\n        const constraintNameRegexMatches = odbcError.message.match(constraintNameRegex);\n        if (constraintNameRegexMatches && constraintNameRegexMatches.length === 3) {\n          constraintName = constraintNameRegexMatches[1];\n          type = constraintNameRegexMatches[2];\n\n          if (type === '*N') {\n            return new sequelizeErrors.UnknownConstraintError({\n              parent: err,\n              constraint: constraintName,\n            });\n          }\n        }\n      }\n\n      return new sequelizeErrors.DatabaseError(odbcError, { stack: stacktrace });\n    }\n\n    return err;\n  }\n}\n\nmodule.exports = Query;\nmodule.exports.Query = Query;\nmodule.exports.default = Query;\n"],
  "mappings": "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",
  "names": []
}
